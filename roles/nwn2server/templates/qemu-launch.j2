#!/bin/sh

set -euo pipefail

FREE_PAGES=$(grep "HugePages_Free" /proc/meminfo | grep -oE "[0-9]+$")
if [[ $FREE_PAGES < {{qemu_memory}} ]]; then
	CURR_PAGES=$(grep "HugePages_Total" /proc/meminfo | grep -oE "[0-9]+$")
	NEW_ALLOC=$(($CURR_PAGES + ({{qemu_memory}} - $FREE_PAGES)))
	echo "Allocating $NEW_ALLOC huge memory pages"
	echo $NEW_ALLOC > /proc/sys/vm/nr_hugepages
fi

exec \
qemu-system-x86_64 \
	-name "NWN2Server" \
	-runas {{unprivileged_user}} \
	\
	-enable-kvm \
	-cpu host \
	-smp {{qemu_smp}} \
	-m {{qemu_memory}}M \
	-mem-path /dev/hugepages \
	\
	-drive file="{{nwn2_path_root}}/nwn2server-vmdisk.{{qemu_disk_format}}",format={{qemu_disk_format}},if=virtio,cache=none \
	\
	-device virtio-net-pci,netdev=net0 \
	-netdev user,id=net0,hostname=nwn2server,hostfwd=udp:0.0.0.0:{{nwn2server_port}}-:{{nwn2server_port}},hostfwd=tcp:127.0.0.1:{{winrm_port}}-:5985 \
	\
	-device piix3-usb-uhci \
	-device pvpanic \
	\
	-vga qxl \
	-spice addr=127.0.0.1,port={{qemu_spice_port}},disable-ticketing \
	-device usb-tablet \
	-device virtio-serial \
	-chardev spicevmc,id=vdagent,name=vdagent \
	-device virtserialport,chardev=vdagent,name=com.redhat.spice.0 \
	\
	-monitor unix:{{nwn2_path_root}}/qemu-monitor.sock,server,nowait \
	$@
