#!/bin/sh

set -euo pipefail

toBytes(){
	echo $@ | awk \
	'BEGIN{IGNORECASE = 1}
	function printpower(n,b,p) {printf "%u\n", n*b^p; next}
	/[0-9]$/{print $1;next};
	/KB?$/{printpower($1,  2, 10)};
	/MB?$/{printpower($1,  2, 20)};
	/GB?$/{printpower($1,  2, 30)};
	/TB?$/{printpower($1,  2, 40)};'
}

# Get get huge page size
PAGE_SIZE=$(toBytes $(grep Hugepagesize /proc/meminfo | grep -oE "[0-9\.]+\s*[kmgt]B$"))
REQUIRED_PAGES=$(($(toBytes {{qemu_memory}}M) / $PAGE_SIZE))

FREE_PAGES=$(grep "HugePages_Free" /proc/meminfo | grep -oE "[0-9]+$")
if [[ $FREE_PAGES < $REQUIRED_PAGES ]]; then
	CURR_PAGES=$(grep "HugePages_Total" /proc/meminfo | grep -oE "[0-9]+$")
	NEW_ALLOC=$(($CURR_PAGES + ($REQUIRED_PAGES - $FREE_PAGES)))
	echo "Allocating $NEW_ALLOC huge memory pages"
	echo $NEW_ALLOC > /proc/sys/vm/nr_hugepages
fi

exec \
qemu-system-x86_64 \
	-name "NWN2Server" \
	-runas {{unprivileged_user}} \
	\
	-enable-kvm \
	-cpu host \
	-smp {{qemu_smp}} \
	-m {{qemu_memory}}M \
	-mem-path /dev/hugepages \
	\
	-drive file="{{nwn2_path_root}}/nwn2server-vmdisk.{{qemu_disk_format}}",format={{qemu_disk_format}},if=virtio,cache=none \
	\
	-netdev tap,id=tap0,ifname=tap0,script=$PWD/qemu-ifup,downscript=$PWD/qemu-ifdown \
	-device virtio-net-pci,netdev=tap0,mac=01:23:45:67:89:{{"%02x" | format(nwn2server_private_ip.split(".")[3] | int)}} \
	\
	-device piix3-usb-uhci \
	-device pvpanic \
	\
	-vga qxl \
	-spice addr=127.0.0.1,port={{qemu_spice_port}},disable-ticketing \
	-device usb-tablet \
	-device virtio-serial \
	-chardev spicevmc,id=vdagent,name=vdagent \
	-device virtserialport,chardev=vdagent,name=com.redhat.spice.0 \
	\
	-monitor unix:{{nwn2_path_root}}/qemu-monitor.sock,server,nowait \
	$@
